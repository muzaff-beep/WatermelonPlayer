name: Android CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2

    - name: Create Missing Launcher Icons
      run: |
        # Create directories
        mkdir -p app/src/main/res/mipmap-anydpi-v26
        mkdir -p app/src/main/res/drawable
        
        # Create adaptive icon XML
        echo '<?xml version="1.0" encoding="utf-8"?>
        <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
            <background android:drawable="@color/primary"/>
            <foreground android:drawable="@drawable/ic_launcher_foreground"/>
        </adaptive-icon>' > app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml
        
        cp app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml
        
        # Create foreground vector
        echo '<?xml version="1.0" encoding="utf-8"?>
        <vector xmlns:android="http://schemas.android.com/apk/res/android"
            android:width="108dp"
            android:height="108dp"
            android:viewportWidth="108"
            android:viewportHeight="108">
            <path
                android:fillColor="#FFFFFF"
                android:pathData="M54,82C70,82 83,69 83,54C83,39 70,26 54,26C39,26 26,39 26,54C26,69 39,82 54,82Z M54,96C26,96 4,74 4,54C4,34 26,12 54,12C82,12 104,34 104,54C104,74 82,96 54,96Z"/>
        </vector>' > app/src/main/res/drawable/ic_launcher_foreground.xml

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build Iran Edition (Debug)
      run: ./gradlew :app:assembleDebug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: watermelon-player-debug
        path: app/build/outputs/apk/debug/*.apk

    - name: Upload Mapping (Release)
      if: github.ref == 'refs/heads/master'
      uses: actions/upload-artifact@v4
      with:
        name: mapping-files
        path: app/build/outputs/mapping/
